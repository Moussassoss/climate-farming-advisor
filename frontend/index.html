<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Climate-Resilient Farming Advisor</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS for the map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="bg-green-50 text-gray-800 min-h-screen flex flex-col items-center p-6">

  <div class="max-w-2xl w-full">
    <h1 class="text-3xl font-bold text-center mb-4">🌾 Climate-Resilient Farming Advisor</h1>
    <p class="text-center mb-6 text-lg">Click the button below to get crop recommendations based on your current location and weather.</p>

    <div class="flex justify-center">
      <button 
        onclick="getRecommendations()" 
        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded shadow transition">
        Get Recommendations
      </button>
    </div>

    <!-- Loading Spinner -->
    <div id="spinner" class="hidden flex justify-center mt-4">
      <div class="animate-spin rounded-full h-8 w-8 border-t-4 border-green-600 border-solid"></div>
    </div>

    <!-- Status Message -->
    <div id="status" class="text-center mt-4 text-gray-600 text-sm"></div>

    <!-- Map -->
    <div id="map" class="h-60 mt-6 rounded shadow hidden"></div>

    <!-- Result Output -->
    <div id="output" class="mt-6 p-4 bg-white rounded shadow hidden">
      <!-- Dynamic content injected here -->
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    let map;

    function showMap(lat, lon) {
      const mapDiv = document.getElementById("map");
      mapDiv.classList.remove("hidden");

      if (!map) {
        map = L.map('map').setView([lat, lon], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
        }).addTo(map);
        L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();
      } else {
        map.setView([lat, lon], 10);
      }
    }

    async function getRecommendations() {
      const output = document.getElementById("output");
      const spinner = document.getElementById("spinner");
      const status = document.getElementById("status");

      output.classList.add("hidden");
      status.innerText = "📍 Detecting your location...";
      spinner.classList.remove("hidden");

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          showMap(lat, lon);
          status.innerText = "📡 Location detected. Fetching recommendations...";

          try {
            const response = await fetch(`http://127.0.0.1:8000/recommend?lat=${lat}&lon=${lon}`);
            const data = await response.json();

            const crops = data.recommendations.map(crop => `<li>${crop}</li>`).join("");

            output.innerHTML = `
              <h2 class="text-xl font-semibold text-green-700 mb-2">✅ Recommended Crops</h2>
              <ul class="list-disc list-inside text-green-800 mb-4">${crops}</ul>
              <h3 class="text-md font-medium text-gray-700 mb-1">🌦 Current Weather</h3>
              <p>🌡️ Temperature: ${data.weather.temperature}°C</p>
              <p>💧 Humidity: ${data.weather.humidity}%</p>
              <p>🌧️ Rainfall: ${data.weather.rain} mm</p>
              <p>☁️ Condition: ${data.weather.description}</p>
            `;

            output.classList.remove("hidden");
            status.innerText = "";
          } catch (err) {
            status.innerText = "❌ Failed to fetch recommendations.";
          } finally {
            spinner.classList.add("hidden");
          }

        }, () => {
          spinner.classList.add("hidden");
          status.innerText = "❌ Location access denied.";
        });
      } else {
        spinner.classList.add("hidden");
        status.innerText = "❌ Geolocation is not supported by this browser.";
      }
    }
  </script>
</body>
</html>
